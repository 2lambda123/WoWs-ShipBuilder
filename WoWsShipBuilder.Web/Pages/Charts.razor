@page "/charts"
@using WoWsShipBuilder.Web.Utility
@using MudBlazor.Services
@using WoWsShipBuilder.Core.DataContainers
@using WoWsShipBuilder.Core.DataProvider
@using WoWsShipBuilder.Core.Extensions
@using WoWsShipBuilder.DataStructures
@using WoWsShipBuilder.DataStructures.Ship
@using WoWsShipBuilder.Web.Dialogs
@using WoWsShipBuilder.Web.Services
@using WoWsShipBuilder.Core.Data

@inject NavigationManager NavManager
@inject ILocalizer Localizer
@inject IDialogService DialogService
@inject ChartJsInterop ChartJsInterop
@inject IMetricsService MetricsService
@inject IBreakpointService BreakpointService

<PageTitle>WoWs ShipBuilder: Charts</PageTitle>
<MudTabs Elevation="2" PanelClass="pa-6" Centered Color="Color.Primary" @ref="chartsTabs" Outlined Border KeepPanelsAlive>
    <MudTabPanel Text="@Localizer.GetAppLocalization(nameof(Translation.ChartsWeb_DispersionCharts)).Localization" ID="ChartsHelper.ChartsTabs.DispersionCharts">
        <MudButton OnClick="EditChartsAsync" Variant="Variant.Filled" Color="Color.Primary" Class="d-flex mx-auto" Disabled="processing">
            @if (processing)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                <MudText Class="ms-2" Typo="Typo.button">
                    @Localizer.GetAppLocalization(nameof(Translation.ShipAndShellSelectionDialogWeb_Loading)).Localization
                </MudText>
            }
            else
            {
                <MudText Typo="Typo.button">
                    @Localizer.GetAppLocalization(nameof(Translation.ChartsWeb_AddRemoveShips)).Localization
                </MudText>
            }
        </MudButton>
        <div>
            <canvas id="@HorizontalDispersionId"></canvas>
        </div>
        <MudGrid Class="d-inline-flex" Style="flex-direction: column">
            <MudItem Class="z-20 mt-1 ml-auto mr-11" xs="12" md="1" Style="@(GetPositionStyleForSelector() +  "align-self: flex-end; min-width: 220px;")">
                <MudSelect Style="min-width: 220px" Label="@Localizer.GetAppLocalization(nameof(Translation.DispersionGraphWindow_PlotPlane)).Localization" @bind-Value="@selectedVertDispersionPlane" Variant="Variant.Outlined" SelectedValuesChanged="@(_ => ChangeVerticalDispPlaneAsync())" T="ChartsHelper.EllipsePlanes" Disabled="processing" Margin="Margin.Dense" AnchorOrigin="Origin.BottomCenter">
                    @foreach (var item in ellipsePlanesList)
                    {
                        <MudSelectItem Value="@item">
                            <MudStack Row AlignItems="AlignItems.Center">
                                <MudIcon Icon="@ChartsHelper.GetPlaneIcon(item)" Style="width: 20px; height: 20px; margin-bottom: 3px"/>
                                <MudText Color="Color.Secondary">@Localizer.GetAppLocalization(Translation.ResourceManager.GetString(item.ToString())!).Localization</MudText>
                            </MudStack>
                        </MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem Class="z-10" xs="12">
                <div>
                    <canvas id="@VerticalDispersionId"></canvas>
                </div>
            </MudItem>
        </MudGrid>
    </MudTabPanel>
    <MudTabPanel Text="@Localizer.GetAppLocalization(nameof(Translation.DispersionGraphWindow_DispersionPlot)).Localization" ID="ChartsHelper.ChartsTabs.DispersionPlot">
        <MudStack>
             <MudExpansionPanels>
                 <MudExpansionPanel Dense="true" Style="border-bottom: initial" Class="header-border border border-solid rounded-0">
                     <TitleContent>
                         <div class="d-flex">
                             <MudIcon Icon="@Icons.Material.Filled.Info" class="mr-3"></MudIcon>
                             <MudText Style="font-size: large">@Localizer.GetAppLocalization(nameof(Translation.DispersionGraphWindow_DispPlotExplanation)).Localization</MudText>
                         </div>
                     </TitleContent>
                     <ChildContent>
                         <div style="white-space: break-spaces">
                             <MudText>@Localizer.GetAppLocalization(nameof(Translation.DispersionGraphWindow_DispPlotDescription)).Localization</MudText>
                         </div>
                     </ChildContent>
                 </MudExpansionPanel>
            </MudExpansionPanels>
            <MudStack Row="true" Style="flex-wrap: wrap">
                <MudButton OnClick="EditChartsAsync" Variant="Variant.Filled" Color="Color.Primary" Class="d-flex mx-auto" Disabled="processing" DisableElevation FullWidth="@SetFullWidth()">
                    @if (processing)
                    {
                        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                        <MudText Class="ms-2" Typo="Typo.button">
                            @Localizer.GetAppLocalization(nameof(Translation.ShipAndShellSelectionDialogWeb_Loading)).Localization
                        </MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.button">
                            @Localizer.GetAppLocalization(nameof(Translation.ChartsWeb_AddRemoveShips)).Localization
                        </MudText>
                    }
                </MudButton>
                <MudNumericField Value="aimingRange" Label="@($"{Localizer.GetAppLocalization(nameof(Translation.ShipStats_Range)).Localization} ({Localizer.GetAppLocalization(nameof(Translation.Unit_KM)).Localization})")" Variant="Variant.Outlined" Immediate="true" ValueChanged="UpdateDispersionPlotRange" T="double" DebounceInterval="500" Disabled="processing" Margin="Margin.Dense" Min="1" Max="50" Step="0.5"/>
                <MudNumericField Value="shotsNumber" Label="@Localizer.GetAppLocalization(nameof(Translation.DispersionGraphWindow_ShotsNumber)).Localization" Variant="Variant.Outlined" Immediate="true" ValueChanged="UpdateDispersionPlotShotsNumber" T="int" DebounceInterval="500" Disabled="processing" Margin="Margin.Dense" Min="1" Max="500" Step="1"/>
                <MudNumericField Value="dispPlotScaling" Label="@Localizer.GetAppLocalization(nameof(Translation.DispersionGraphWindow_PlotScaling)).Localization" Variant="Variant.Outlined" Immediate="true" ValueChanged="UpdateDispersionPlotScaling" T="double" DebounceInterval="500" Disabled="processing" Margin="Margin.Dense" Min="0.1" Max="4" Step="0.1"/>
                <MudSelect Style="min-width: 196px" Label="@Localizer.GetAppLocalization(nameof(Translation.DispersionGraphWindow_PlotOrientation)).Localization" Variant="Variant.Outlined" T="bool" Disabled="processing" Margin="Margin.Dense" AnchorOrigin="Origin.BottomCenter" SelectedValuesChanged="@(_ => SetVerticalDispersionPlot(!verticalDispPlot))">
                    <MudSelectItem Value="@false">
                        <MudText Color="Color.Secondary">@Localizer.GetAppLocalization(nameof(Translation.DispersionGraphWindow_Horizontal)).Localization</MudText>
                    </MudSelectItem>
                    <MudSelectItem Value="@true">
                        <MudText Color="Color.Secondary">@Localizer.GetAppLocalization(nameof(Translation.DispersionGraphWindow_Vertical)).Localization</MudText>
                    </MudSelectItem>
                </MudSelect>
                <MudSelect Style="min-width: 254px" Label="@Localizer.GetAppLocalization(nameof(Translation.DispersionGraphWindow_PlotPlane)).Localization" @bind-Value="@selectedDispPlotPlane" Variant="Variant.Outlined" T="ChartsHelper.EllipsePlanes" Disabled="processing" Margin="Margin.Dense" AnchorOrigin="Origin.BottomCenter">
                    @foreach (var item in ellipsePlanesList)
                    {
                        <MudSelectItem Value="@item">
                            <MudStack Row AlignItems="AlignItems.Center">
                                <MudIcon Icon="@ChartsHelper.GetPlaneIcon(item)" Style="width: 20px; height: 20px; margin-bottom: 3px"/>
                                <MudText Color="Color.Secondary">@Localizer.GetAppLocalization(item.ToString()).Localization</MudText>
                            </MudStack>
                        </MudSelectItem>
                    }
                </MudSelect>
                <MudSelect Style="min-width: 194px" Label="@Localizer.GetAppLocalization(nameof(Translation.DispersionGraphWindow_DrawFusoReference)).Localization" @bind-Value="@selectedFusoPosition" Variant="Variant.Outlined" T="DispersionPlot.FusoPositions" Disabled="processing" Margin="Margin.Dense" AnchorOrigin="Origin.BottomCenter">
                    @foreach (var item in fusoPositionsList)
                    {
                        <MudSelectItem Value="@item">
                            <MudText Color="Color.Secondary">@Localizer.GetAppLocalization(item.ToString()).Localization</MudText>
                        </MudSelectItem>
                    }
                </MudSelect>
            </MudStack>
            <DispersionPlot Ships="cache.Values.Select(x => x.DispPlotShipsCache).ToList()" EllipsePlane="selectedDispPlotPlane" FusoPosition="selectedFusoPosition" IsVertical="verticalDispPlot" PlotScaling="dispPlotScaling" Tab="@((ChartsHelper.ChartsTabs)chartsTabs.ActivePanel.ID)"/>
        </MudStack>
    </MudTabPanel>
    <MudTabPanel Text="@Localizer.GetAppLocalization(nameof(Translation.ChartsWeb_BallisticCharts)).Localization" ID="ChartsHelper.ChartsTabs.BallisticCharts">
        <MudButton OnClick="EditChartsAsync" Variant="Variant.Filled" Color="Color.Primary" Class="d-flex mx-auto" Disabled="processing">
            @if (processing)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                <MudText Class="ms-2" Typo="Typo.button">
                    @Localizer.GetAppLocalization(nameof(Translation.ShipAndShellSelectionDialogWeb_Loading)).Localization
                </MudText>
            }
            else
            {
                <MudText Typo="Typo.button">
                    @Localizer.GetAppLocalization(nameof(Translation.ChartsWeb_AddRemoveShips)).Localization
                </MudText>
            }
        </MudButton>
        <div>
            <canvas id="@PenetrationId"></canvas>
        </div>
        <div>
            <canvas id="@FlightTimeId"></canvas>
        </div>
        <div>
            <canvas id="@ImpactVelocityId"></canvas>
        </div>
        <div>
            <canvas id="@ImpactAngleId"></canvas>
        </div>
    </MudTabPanel>
    <MudTabPanel Text="@Localizer.GetAppLocalization(nameof(Translation.ChartsWeb_ShellTrajectoryChart)).Localization" ID="ChartsHelper.ChartsTabs.TrajectoryChart">
        <MudButton OnClick="EditChartsAsync" Variant="Variant.Filled" Color="Color.Primary" Class="d-flex mx-auto mb-2" Disabled="processing">
            @if (processing)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                <MudText Class="ms-2" Typo="Typo.button">
                    @Localizer.GetAppLocalization(nameof(Translation.ShipAndShellSelectionDialogWeb_Loading)).Localization
                </MudText>
            }
            else
            {
                <MudText Typo="Typo.button">
                    @Localizer.GetAppLocalization(nameof(Translation.ChartsWeb_AddRemoveShips)).Localization
                </MudText>
            }
        </MudButton>
        <MudGrid Class="d-inline-flex" Style="flex-direction: column">
            <MudItem Class="z-20 mt-1 ml-auto mr-5 d-inline-flex" xs="12" md="1" Style="@(GetPositionStyleForSelector() +  "align-self: flex-end;")">
                <MudNumericField Value="range" Label="@Localizer.GetAppLocalization(nameof(Translation.ShipStats_Range)).Localization" Variant="Variant.Outlined" Immediate="true" ValueChanged="UpdateTrajectoryAsync" T="double" DebounceInterval="250" Disabled="processing" Margin="Margin.Dense" Min="0"/>
            </MudItem>
            <MudItem Class="z-10" xs="12">
                <div>
                    <canvas id="@TrajectoryId"></canvas>
                </div>
            </MudItem>
        </MudGrid>
    </MudTabPanel>
</MudTabs>
<MudScrollToTop TopOffset="100" Style="z-index:2001">
    <MudFab Color="Color.Info" StartIcon="@Icons.Filled.KeyboardDoubleArrowUp"/>
</MudScrollToTop>

@code
{
    private Breakpoint Breakpoint { get; set; }

    private const string HorizontalDispersionId = "horizontal-dispersion";
    private const string VerticalDispersionId = "vertical-dispersion";
    private const string TrajectoryId = "trajectory";
    private const string PenetrationId = "penetration";
    private const string FlightTimeId = "flight-time";
    private const string ImpactVelocityId = "impact-velocity";
    private const string ImpactAngleId = "impact-angle";
        
    private const string DefaultBuildName = "---";

    private string shellIndexFromUrl = string.Empty;
    private string[] shipIndexesFromUrl = { };

    private bool processing;
    private double range = 10;
    private double aimingRange = 10;
    private int shotsNumber = 100;
    private bool verticalDispPlot;
    private double dispPlotScaling = 1.0;
    private int counter;
    private ChartsHelper.EllipsePlanes selectedVertDispersionPlane = ChartsHelper.EllipsePlanes.RealPlane;
    private ChartsHelper.EllipsePlanes selectedDispPlotPlane = ChartsHelper.EllipsePlanes.HorizontalPlane;
    private DispersionPlot.FusoPositions selectedFusoPosition = DispersionPlot.FusoPositions.DontShow;

    private MudTabs chartsTabs = default!;
    
    private readonly Dictionary<Guid, ChartsDataWrapper> displayedShips = new();
    private readonly Dictionary<ChartsCacheKey, ChartsCacheValue> cache = new(); //TODO to move later inside the ChartsDataWrapper

    private readonly List<ChartsHelper.EllipsePlanes> ellipsePlanesList = Enum.GetValues<ChartsHelper.EllipsePlanes>().ToList();
    private readonly List<DispersionPlot.FusoPositions> fusoPositionsList = Enum.GetValues<DispersionPlot.FusoPositions>().ToList();

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        MetricsService.BallisticPageCount.Inc();

        if (NavManager.TryGetQueryString("shellIndex", out string shellIndex))
        {
            shellIndexFromUrl = shellIndex;
        }
        if (NavManager.TryGetQueryString("shipIndex", out string shipIndex))
        {
            shipIndexesFromUrl = shipIndex.Split(',');
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);

        if (firstRender)
        {
            SetProcessing(true);
            Breakpoint = await BreakpointService.GetBreakpoint();
            await SetupChartsAsync();
            if (shipIndexesFromUrl.Any())
            {
                if (shellIndexFromUrl.Any())
                {
                    //TODO Enable when passing builds through server cache is implemented
                    
                    // string shipIndex = shipIndexesFromUrl.First();
                    // var shipSummary = AppData.ShipSummaryList.First(x => x.Index.Equals(shipIndex));
                    // var ship = AppData.FindShipFromSummary(shipSummary);
                    //
                    // IEnumerable<string> shellIndexes = ship.MainBatteryModuleList.SelectMany(turretModule => turretModule.Value.Guns.SelectMany(g => g.AmmoList)).Distinct();
                    // ChartsDataWrapper wrapper = new(ShipBuildContainer.CreateNew(ship, null, null), shellIndexes.ToList());
                    //
                    // selectedShipList.Add(wrapper);
                }
                else
                {
                    List<ChartsDataWrapper> shipList = new();
                    foreach (string shipIndex in shipIndexesFromUrl)
                    {
                        var shipSummary = AppData.ShipSummaryList.Single(x => x.Index.Equals(shipIndex));
                        var ship = AppData.FindShipFromSummary(shipSummary);
                        
                        List<ShipUpgrade> shipConfiguration = ShipModuleHelper.GroupAndSortUpgrades(ship.ShipUpgradeInfo.ShipUpgrades)
                                .OrderBy(entry => entry.Key)
                                .Select(entry => entry.Value)
                                .Select(module => module.First())
                                .ToList();

                        ChartsDataWrapper wrapper = new(ShipBuildContainer.CreateNew(ship, null, null) with { ShipDataContainer = ShipDataContainer.CreateFromShip(ship, shipConfiguration, new()) } , new());
                        shipList.Add(wrapper);
                    }

                    DialogOptions options = new()
                    {
                        MaxWidth = MaxWidth.ExtraLarge,
                    };
                    var parameters = new DialogParameters
                    {
                        ["InputData"] = shipList,
                    };
                    var dialog = DialogService.Show<ShipAndShellSelectionDialogNew>("ShipAndShellSelectionDialog", parameters, options);
                    var result = await dialog.Result;
                    if (result is null || result.Cancelled)
                    {
                        SetProcessing(false);
                        return;
                    }
                    await UpdateChartsBatchAsync((ShipAndShellSelectionDialogOutput)result.Data);
                }
            }
            SetProcessing(false);
        }
    }

    private async Task SetupChartsAsync()
    {
        string km = Localizer.GetAppLocalization(nameof(Translation.Unit_KM)).Localization;
        string m = Localizer.GetAppLocalization(nameof(Translation.Unit_M)).Localization;
        string rangeString = Localizer.GetAppLocalization(nameof(Translation.ShipStats_Range)).Localization;
        string s = Localizer.GetAppLocalization(nameof(Translation.Unit_S)).Localization;
        string mm = Localizer.GetAppLocalization(nameof(Translation.Unit_MM)).Localization;
        string degree = Localizer.GetAppLocalization(nameof(Translation.Unit_Degree)).Localization;
        string mps = Localizer.GetAppLocalization(nameof(Translation.Unit_MPS)).Localization;

        double aspectRatio = 3;
        if (Breakpoint is Breakpoint.Sm or Breakpoint.Xs)
        {
            aspectRatio = 1.2;
        }

        await ChartJsInterop.SetupGlobalChartConfigAsync(aspectRatio);

        await ChartJsInterop.CreateChartAsync(HorizontalDispersionId, Localizer.GetAppLocalization(nameof(Translation.DispersionGraphWindow_Horizontal)).Localization, rangeString, Localizer.GetAppLocalization(nameof(Translation.ShipStats_Dispersion)).Localization, km, m);
        await ChartJsInterop.CreateChartAsync(VerticalDispersionId, Localizer.GetAppLocalization(nameof(Translation.DispersionGraphWindow_Vertical)).Localization, rangeString, Localizer.GetAppLocalization(nameof(Translation.ShipStats_Dispersion)).Localization, km, m);
        await ChartJsInterop.CreateChartAsync(TrajectoryId, Localizer.GetAppLocalization(nameof(Translation.DispersionGraphWindow_ShellsPath)).Localization, rangeString, Localizer.GetAppLocalization(Translation.ChartsWeb_Height).Localization, km, m);
        await ChartJsInterop.CreateChartAsync(PenetrationId, Localizer.GetAppLocalization(nameof(Translation.ShipStats_Penetration)).Localization, rangeString, Localizer.GetAppLocalization(nameof(Translation.ShipStats_Penetration)).Localization, km, mm);
        await ChartJsInterop.CreateChartAsync(FlightTimeId, Localizer.GetAppLocalization(nameof(Translation.DispersionGraphWindow_FlightTime)).Localization, rangeString, Localizer.GetAppLocalization(nameof(Translation.DispersionGraphWindow_FlightTime)).Localization, km, s);
        await ChartJsInterop.CreateChartAsync(ImpactVelocityId, Localizer.GetAppLocalization(nameof(Translation.DispersionGraphWindow_ImpactVelocity)).Localization, rangeString, Localizer.GetAppLocalization(nameof(Translation.DispersionGraphWindow_ImpactVelocity)).Localization, km, mps);
        await ChartJsInterop.CreateChartAsync(ImpactAngleId, Localizer.GetAppLocalization(nameof(Translation.DispersionGraphWindow_ImpactAngle)).Localization, rangeString, Localizer.GetAppLocalization(nameof(Translation.DispersionGraphWindow_ImpactAngle)).Localization, km, degree);
        await ChartJsInterop.ChangeSuggestedMaxAsync(TrajectoryId, range / 4 * 1000);
    }

    private async Task UpdateChartsBatchAsync(ShipAndShellSelectionDialogOutput data)
    {
        List<string> chartIds = GetChartsIdList();
        foreach (var (id, wrapper) in data.ShipsToModify)
        {
            foreach (string shellIndex in displayedShips[id].SelectedShellsIndexes.Where(shellIndex => !wrapper.SelectedShellsIndexes.Contains(shellIndex)))
            {
                await RemoveCharts(chartIds, data.ShipsToRemove); // TODO replace with proper method once implemented
            }
        }
        
        await GenerateCharts(chartIds, data.ShipsToModify.Values.ToList());
        await GenerateCharts(chartIds, data.ShipsToAdd);
        await RemoveCharts(chartIds, data.ShipsToRemove);
    }

    private async Task GenerateCharts(List<string> chartIds, List<ChartsDataWrapper> data)
    {
        //IEnumerable<Point> is a single dataset. The middle List contains all datasets of a certain chart. The outermost List contains the list of datasets of each chart.
        List<List<IEnumerable<ChartsHelper.Point>>> plotData = new();
        List<int> indexes = new();
        List<string> newLabels = new();
        
        foreach (var shipToAdd in data)
        {
            var shipId = shipToAdd.ShipContainer.Id;
            var dispersionData = shipToAdd.ShipContainer.ShipDataContainer!.MainBatteryDataContainer!.DispersionData;
            var maxRange = (double) shipToAdd.ShipContainer.ShipDataContainer.MainBatteryDataContainer.Range;
            var shellCaliber = (float) shipToAdd.ShipContainer.ShipDataContainer.MainBatteryDataContainer.GunCaliber;
            var sigma = (double) shipToAdd.ShipContainer.ShipDataContainer.MainBatteryDataContainer.Sigma;
            foreach (string shellIndex in shipToAdd.SelectedShellsIndexes)
            {
                if (displayedShips[shipId].SelectedShellsIndexes.Contains(shellIndex))
                {
                    continue;
                }
                
                var shell = shipToAdd.ShipContainer.ShipDataContainer!.MainBatteryDataContainer!.ShellData.First(x => x.Name.Equals(shellIndex));

                Dictionary<double, Ballistic> ballisticSeries = GetBallistic(shipId, shellIndex, (float)shell.ShellVelocity, shellCaliber, (float)shell.Mass, (float)shell.Krupp, (float)shell.AirDrag, maxRange, shell.Type.Equals($"ArmamentType_{ShellType.AP.ShellTypeToString()}") ? null : shell.Penetration);

                List<IEnumerable<ChartsHelper.Point>> shipData = new()
                {
                    ChartsHelper.CreateHorizontalDispersionChartDataset(dispersionData, maxRange),
                    CreateVerticalDispersionChartDataset(shipId, shellIndex, dispersionData, maxRange, ballisticSeries),
                    ChartsHelper.CreateTrajectoryDataset(ballisticSeries, range),
                    ChartsHelper.CreateBallisticChartDataset(ballisticSeries, ChartsHelper.BallisticParameter.Penetration),
                    ChartsHelper.CreateBallisticChartDataset(ballisticSeries, ChartsHelper.BallisticParameter.FlightTime),
                    ChartsHelper.CreateBallisticChartDataset(ballisticSeries, ChartsHelper.BallisticParameter.ImpactVelocity),
                    ChartsHelper.CreateBallisticChartDataset(ballisticSeries, ChartsHelper.BallisticParameter.ImpactAngle),
                };
                plotData.Add(shipData);
                indexes.Add(counter);
                counter++;

                string label = GenerateLocalizedLabel(shipToAdd.ShipContainer.Ship.Index, shipToAdd.ShipContainer.ShipDataContainer.MainBatteryDataContainer.GunCaliber, shell.Type, shipToAdd.ShipContainer.Build?.BuildName);
                newLabels.Add(label);
                
                AddToCache(shipToAdd.ShipContainer.Id, shellIndex, DispersionPlotHelper.CalculateDispersionPlotParameters(label, dispersionData, (float)shell.ShellVelocity, shellCaliber, (float)shell.Mass, (float)shell.Krupp, (float)shell.AirDrag, maxRange, aimingRange * 1000, sigma, shotsNumber));
            }
            displayedShips[shipId] = shipToAdd;
        }
        await ChartJsInterop.BatchAddDataAsync(chartIds, data.Select(x => x.ShipContainer.Id).ToList(), newLabels, plotData, indexes);
    }
    
    private async Task RemoveCharts(List<string> chartIds, List<Guid> data)
    {
        foreach (var id in data)
        {
            displayedShips.Remove(id);
            RemoveFromCache(id);
        }
        await ChartJsInterop.BatchRemoveDataAsync(chartIds, data);
    }

    private void AddToCache(ChartsCacheKey key, object obj)
    {
        AddToCache(key.ChartsDataWrapperId, key.ShellIndex, obj);
    }

    private void AddToCache(Guid id, string label, object obj)
    {
        ChartsCacheKey cacheKey = new(id, label);
        switch (obj)
        {
            case DispersionEllipse disp when cache.ContainsKey(cacheKey):
                cache[cacheKey] = cache[cacheKey] with { DispPlotShipsCache = disp };
                break;
            case DispersionEllipse disp:
                cache.Add(cacheKey, new(disp, null, null));
                break;
            case VerticalDispersions vert when cache.ContainsKey(cacheKey):
                cache[cacheKey] = cache[cacheKey] with { VerticalDispersionsCache = vert };
                break;
            case VerticalDispersions vert:
                cache.Add(cacheKey, new(null, vert, null));
                break;
            case Dictionary<double, Ballistic> ballistic when cache.ContainsKey(cacheKey):
                cache[cacheKey] = cache[cacheKey] with { BallisticCache = ballistic };
                break;
            case Dictionary<double, Ballistic> ballistic:
                cache.Add(cacheKey, new(null, null, ballistic));
                break;
        }
    }

    private void RemoveFromCache(Guid id)
    {
        IEnumerable<ChartsCacheKey> list = cache.Keys.Where(x => x.ChartsDataWrapperId.Equals(id));
        foreach (var ship in list)
        {
            cache.Remove(ship);
        }
    }

    private string GenerateLocalizedLabel(string shipIndex, decimal gunCaliber, string shellType, string? buildName)
    {
        ShellType type;
        
        if (shellType.Equals($"ArmamentType_{ShellType.SAP.ShellTypeToString()}"))
        {
            type = ShellType.SAP;
        }
        else if (shellType.Equals($"ArmamentType_{ShellType.HE.ShellTypeToString()}"))
        {
            type = ShellType.HE;
        }
        else
        {
            type = ShellType.AP;
        }
        
        return $"{Localizer.GetGameLocalization($"{shipIndex}_FULL").Localization} - {gunCaliber}{Localizer.GetAppLocalization(Translation.Unit_MM)} {type.ShellTypeToString()} - {buildName ?? DefaultBuildName}";
    }
    
    private Dictionary<double, Ballistic> GetBallistic(Guid id, string shellIndex, float muzzleVelocity, float caliber, float mass, float krupp, float airDrag, double maxRange, float? penetration)
    {
        ChartsCacheKey cacheKey = new(id, shellIndex);
        if (cache.ContainsKey(cacheKey) && cache[cacheKey].BallisticCache is not null)
        {
            return cache[cacheKey].BallisticCache!;
        }
        Dictionary<double, Ballistic> ballisticSeries = BallisticHelper.CalculateBallistic(muzzleVelocity, caliber, mass, krupp, airDrag, maxRange, penetration);
        AddToCache(cacheKey, ballisticSeries);
        return ballisticSeries;
    }

    private IEnumerable<ChartsHelper.Point> CreateVerticalDispersionChartDataset(Guid id, string shellIndex, Dispersion dispersionValues, double maxRange, Dictionary<double, Ballistic> ballisticSeries)
    {
        ChartsCacheKey cacheKey = new(id, shellIndex);
        if (cache.ContainsKey(cacheKey) && cache[cacheKey].VerticalDispersionsCache is not null)
        {
            return ChartsHelper.SelectVerticalDispersionDataset(cache[cacheKey].VerticalDispersionsCache!, selectedVertDispersionPlane);
        }
        var verticalDispersions = ChartsHelper.CreateVerticalDispersionSeries(dispersionValues, maxRange, ballisticSeries);
        AddToCache(cacheKey, verticalDispersions);
        return ChartsHelper.SelectVerticalDispersionDataset(verticalDispersions, selectedVertDispersionPlane);
    }

    private async Task ChangeVerticalDispPlaneAsync()
    {
        SetProcessing(true);
        List<IEnumerable<ChartsHelper.Point>> selectedVerticals = cache.Select(item => ChartsHelper.SelectVerticalDispersionDataset(cache[item.Key].VerticalDispersionsCache!, selectedVertDispersionPlane)).ToList();
        List<Guid> shipIds = displayedShips.Values.Select(x => x.ShipContainer.Id).ToList();
        await ChartJsInterop.BatchUpdateDataAsync(VerticalDispersionId, shipIds, selectedVerticals);
        SetProcessing(false);
    }

    private async Task UpdateTrajectoryAsync(double selectedRange)
    {
        SetProcessing(true);
        range = selectedRange;
        List<IEnumerable<ChartsHelper.Point>> trajectoryData = cache.Select(item => ChartsHelper.CreateTrajectoryDataset(cache[item.Key].BallisticCache!, range)).ToList();
        List<Guid> shipIds = displayedShips.Values.Select(x => x.ShipContainer.Id).ToList();
        await ChartJsInterop.BatchUpdateDataAsync(TrajectoryId, shipIds, trajectoryData);
        await ChartJsInterop.ChangeSuggestedMaxAsync(TrajectoryId, aimingRange / 4 * 1000);
        SetProcessing(false);
    }

    private async Task EditChartsAsync()
    {
        SetProcessing(true);
        var selectedShipList = await GetSelectedShipsAsync();
        if (selectedShipList is null || selectedShipList.Cancelled)
        {
            SetProcessing(false);
            return;
        }

        await UpdateChartsBatchAsync((ShipAndShellSelectionDialogOutput)selectedShipList.Data);
        SetProcessing(false);
    }

    private async Task<DialogResult?> GetSelectedShipsAsync()
    {
        DialogOptions options = new()
        {
            MaxWidth = MaxWidth.ExtraLarge,
        };
        var parameters = new DialogParameters
        {
            ["InputData"] = displayedShips.Values.ToList(),
        };
        var dialog = DialogService.Show<ShipAndShellSelectionDialogNew>("ShipAndShellSelectionDialog", parameters, options);
        return await dialog.Result;
    }

    private static List<string> GetChartsIdList()
    {
        List<string> chartIds = new()
        {
            HorizontalDispersionId,
            VerticalDispersionId,
            TrajectoryId,
            PenetrationId,
            FlightTimeId,
            ImpactVelocityId,
            ImpactAngleId,
        };
        return chartIds;
    }

    private string GetPositionStyleForSelector()
    {
        return Breakpoint is Breakpoint.Xs or Breakpoint.Sm ? "margin-right: auto !important;" : "position: absolute;";
    }

    //Convenience method to call StateHasChanged after setting processing to false. Needed for chrome to correctly update the Ship/Shell selection button.
    private void SetProcessing(bool newProcessing)
    {
        processing = newProcessing;
        if (!newProcessing)
        {
            StateHasChanged();
        }
    }

    private void UpdateDispersionPlotParameters()
    {
        foreach (((var chartsDataWrapperId, string shellIndex), var (dispPlotShipsCache, _, _)) in cache)
        {
            AddToCache(chartsDataWrapperId, shellIndex, DispersionPlotHelper.CalculateDispersionPlotParameters(dispPlotShipsCache!.Name, dispPlotShipsCache.DispersionData, dispPlotShipsCache.MuzzleVelocity, dispPlotShipsCache.Caliber, dispPlotShipsCache.Mass, dispPlotShipsCache.Krupp, dispPlotShipsCache.AirDrag, dispPlotShipsCache.MaxRange, aimingRange * 1000, dispPlotShipsCache.Sigma, shotsNumber));
        }
    }

    private void UpdateDispersionPlotRange(double selectedValue)
    {
        aimingRange = selectedValue;
        UpdateDispersionPlotParameters();
    }

    private void UpdateDispersionPlotShotsNumber(int selectedValue)
    {
        shotsNumber = selectedValue;
        UpdateDispersionPlotParameters();
    }

    private void UpdateDispersionPlotScaling(double selectedValue)
    {
        dispPlotScaling = Math.Round(selectedValue, 1);
    }

    private void SetVerticalDispersionPlot(bool active)
    {
        verticalDispPlot = active;
    }

    private bool SetFullWidth()
    {
        return Breakpoint is Breakpoint.Xs or Breakpoint.Sm;
    }
}