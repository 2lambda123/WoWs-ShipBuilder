@page "/"
@using System.Collections.ObjectModel
@using System.Collections.Specialized
@using System.Net
@using WoWsShipBuilder.Core.Builds
@using WoWsShipBuilder.Web.Data
@using WoWsShipBuilder.Web.Services
@inject NavigationManager NavManager
@inject RefreshNotifierService NotifierService
@inject ISnackbar Snackbar
@inject BuildHelper BuildHelper
@inject ILocalizer Localizer
@implements IDisposable

<PageTitle>
    WoWs ShipBuilder
</PageTitle>

<MudContainer>
    <MudGrid Justify="Justify.Center">
        <MudItem xs="12">
            <MudText Align="Align.Center" Typo="Typo.h1" Class="main-title">
                WoWs ShipBuilder
            </MudText>
            <MudText Align="Align.Center" Typo="Typo.h4">
                Welcome to the WoWs ShipBuilder web app.
            </MudText>
        </MudItem>
        <MudItem xs="12">
            <MudStack Row>
                <MudTextField Immediate T="string" Label="@Localizer.GetAppLocalization(nameof(Translation.BuildStringInputDialog_EnterBuildString)).Localization" @bind-Value="buildString" />
                <MudButton Disabled="@string.IsNullOrWhiteSpace(buildString)" Variant="Variant.Filled" Color="Color.Primary" DisableElevation="true" OnClick="OnLoadBuild">
                    @Localizer.GetAppLocalization(nameof(Translation.WebApp_LoadBuild)).Localization
                </MudButton>
            </MudStack>
        </MudItem>
        <MudItem xs="12" Class="pt-6 pb-0 ml-n4 mr-4">
            <MudDivider DividerType="DividerType.Middle" Style="width: 100%" Light/>
        </MudItem>
        <MudItem xs="12">
            <ShipSelector SelectedShips="@selectedShips" AllowCopies/>
        </MudItem>
        <MudItem xs="12" sm="8" Class="d-flex" Style="justify-content: space-between">
            <MudButton Disabled="@(selectedShips.Count == 0)" Variant="Variant.Filled" Color="Color.Primary" DisableElevation="true" OnClick="@GoToShipPage" FullWidth="true">
                @Localizer.GetAppLocalization(nameof(Translation.WebApp_GoToShipsPage)).Localization
            </MudButton>
        </MudItem>
    </MudGrid>
</MudContainer>

@code
{
    private readonly ObservableCollection<ShipSelector.ShipSelectorContainer> selectedShips = new();
    
    private string buildString = string.Empty;

    protected override void OnInitialized()
    {
        base.OnInitialized();
        selectedShips.CollectionChanged += SelectedShipsOnCollectionChanged;
        NotifierService.RefreshRequested += OnRefresh;
    }

    private void SelectedShipsOnCollectionChanged(object? sender, NotifyCollectionChangedEventArgs e)
    {
        StateHasChanged();
    }

    private void OnRefresh()
    {
        StateHasChanged();
    }

    private async Task GoToShipPage()
    {
        string indexes = string.Join(",", selectedShips.Select(x => x.ShipIndex));
        var containers = new List<BuildHelper.BuildHelperContainer>();
        foreach (var ship in selectedShips)
        {
            var buildStr = string.Empty;
            if (!string.IsNullOrEmpty(ship.BuildString) && ship.BuildString.Contains("build="))
            {
                var index = ship.BuildString.LastIndexOf("build=", StringComparison.Ordinal);
                buildStr = index != -1 ? WebUtility.UrlDecode(ship.BuildString[(index + 6)..]) : string.Empty;
            }
            else if (!string.IsNullOrEmpty(ship.BuildString))
            {
                buildStr = ship.BuildString;
            }
            containers.Add(new(buildStr, null, null));
        }
        await BuildHelper.StoreBuildContainers(containers);
        NavManager.NavigateTo("/ship?shipIndexes=" + indexes);
    }

    public void Dispose()
    {
        selectedShips.CollectionChanged -= SelectedShipsOnCollectionChanged;
        NotifierService.RefreshRequested -= OnRefresh;
    }

    private void OnLoadBuild()
    {
        if (buildString.Contains("share.wowssb.com"))
        {
            NavManager.NavigateTo(buildString);
        }
        else if (buildString.Contains("/ship?"))
        {
            try
            {
                string buildStr = buildString;
                var i = buildStr.IndexOf("build=", StringComparison.Ordinal);
                buildStr = i != -1 ? buildStr[(i + 6)..] : string.Empty;
                Build.CreateBuildFromString(WebUtility.UrlDecode(buildStr));
                
                var index = buildString.IndexOf("/ship?", StringComparison.Ordinal);
                buildString = index != -1 ? buildString[index..] : string.Empty;
                NavManager.NavigateTo(buildString);
                Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomStart;
                Snackbar.Add("Build loaded", Severity.Success);
            }
            catch (FormatException)
            {
                Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomStart;
                Snackbar.Add("Failed to load build from string", Severity.Error);
            }   
        }
        else
        {
            try
            {
                var build = Build.CreateBuildFromString(buildString);
                NavManager.NavigateTo($"/ship?shipIndexes={build.ShipIndex}&build={WebUtility.UrlEncode(buildString)}");
                Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomStart;
                Snackbar.Add("Build loaded", Severity.Success);
            }
            catch (FormatException)
            {
                Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomStart;
                Snackbar.Add("Failed to load build from string", Severity.Error);
            }
        }
    }
}